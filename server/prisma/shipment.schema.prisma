// Shipment Database Schema
// This is a separate database to avoid main database bloat

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/@prisma/shipment-client"
}

datasource db {
  provider = "sqlite"
  url      = env("SHIPMENT_DATABASE_URL")
}

model Shipment {
  id              String   @id @default(uuid())
  code            String   @unique  // RSL-YYMMDD-XXX
  
  // 关联字段（存储 ID，跨库关联到主库）
  customerId      String
  transportTypeId Int
  businessTypeId  Int
  loadingMethodId Int?
  
  // 海运业务字段
  blNumber        String?  // 提单号 (Bill of Lading Number)
  consignee       String?  // 收发货人 (Consignee)
  notifyParty     String?  // 通知人 (Notify Party)
  
  // 港口信息（关联到主库 Port 表）
  polId           String?  // 起运港 ID (Port of Loading)
  podId           String?  // 目的港 ID (Port of Discharge)
  
  // 贸易条款（关联到主库 TradeTerms 表）
  incotermId      Int?     // 贸易条款 ID
  
  // 船期信息
  vesselVoyage    String?  // 船名航次 (Vessel/Voyage)
  etd             BigInt?  // Estimated Time of Departure (timestamp ms)
  eta             BigInt?  // Estimated Time of Arrival (timestamp ms)
  ata             BigInt?  // Actual Time of Arrival (timestamp ms, 仅进口)
  
  // 状态
  status          String   @default("draft")  // 'draft', 'in-progress', 'completed', 'archived'
  
  // 时间戳
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // 关系（业务库内）
  commodities     ShipmentCommodity[]

  attachments     ShipmentAttachment[]
  
  @@index([customerId])
  @@index([code])
  @@index([status])
  @@index([transportTypeId])
  @@index([businessTypeId])
  @@index([polId])
  @@index([podId])
  @@index([createdAt])
}

model ShipmentCommodity {
  id          String   @id @default(uuid())
  shipmentId  String
  commodity   String              // 品名 (Commodity Name) *
  hsCode      String?             // HS CODE (Harmonized System Code)
  sequence    Int      @default(0) // 排序序号
  createdAt   DateTime @default(now())
  
  // 关系
  shipment    Shipment @relation(fields: [shipmentId], references: [id], onDelete: Cascade)
  
  @@index([shipmentId])
  @@index([sequence])
}



model ShipmentAttachment {
  id          String   @id @default(uuid())
  shipmentId  String
  fileName    String
  fileUrl     String
  fileSize    Int
  uploadedAt  DateTime @default(now())
  
  // 关系
  shipment    Shipment @relation(fields: [shipmentId], references: [id], onDelete: Cascade)
  
  @@index([shipmentId])
}

model ShipmentCodeSequence {
  dateKey String @id
  seq     Int    @default(0)
}
